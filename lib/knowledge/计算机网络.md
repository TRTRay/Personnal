# 计算机网络知识

[TOC]



## 协议分层

TCP/IP 5层协议

- 应用层
- 运输层
- 网络层
- 链路层
- 物理层

OSI模型

- 应用层
- 表示层
- 会话层
- 运输层
- 网络层
- 链路层
- 物理层



### 应用层

提供应用层协议，支持网络应用间相互通信

### 运输层

运输层协议为运行在不同主机上的应用进程之间提供了逻辑通信功能

### 网络层

### 链路层

### 物理层



## HTTP

HTTP（超文本传输协议）是一种应用层协议，

HTTP选择TCP作为支撑运输协议

HTTP是一个无状态协议

默认80端口

### 非持续连接和持续连接

又叫短链接和长连接

非持续连接：是指每次TCP连接只传输一个请求报文和响应报文，该连接不为传输其他对象而持续

持续连接：是指TCP连接建立后，后续的请求和相应都能通过该连接，一般来说在一段时间没有使用时会关闭

> RTT（往返时间）
>
> 是指一个短分组从客户端到服务器再返回客户端的时间

### HTTP报文格式

#### 请求报文

![img](https://img-blog.csdn.net/20180524203826916?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h5eDEwNw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

<center style = "color:#c0c0c0">请求报文通用格式</center>

- 请求方法：GET、POST、HEAD、PUT、DELETE
  - GET：是客户端向服务器请求对象时最常见的一种方式，请求参数和对应的值（输入）都跟在URL后面，并且传递参数的长度受限；而且要求服务器将请求的资源放在响应报文的数据部分
  - POST：会将上传的内容放在请求正文（Body）里，相比GET要安全得多
- URL标识了请求资源所在的服务器主机名和对象的路径名

#### 响应报文

![img](https://img-blog.csdn.net/20180524203947215?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h5eDEwNw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

<center style = "color:#c0c0c0">响应报文通用格式</center>

- 状态码：

  - 1××：接受的信息正在处理
  - 2××：请求正常处理完毕
  - 3××：重定向
  - 4××：客户端错误
  - 5××：服务端错误

  常见状态码：

  - 200：请求成功，信息返回在响应报文中
  - 301：永久重定向，新的URL定义在响应报文的首部行Location字段中
  - 302：临时重定向
  - 400：客户请求的报文有错误
  - 403：服务器禁止访问资源
  - 404：资源不在服务器上

### cookie

HTTP本身是一个无状态协议

但是通过cookie能够通过==在客户端保持状态==来标识用户身份并将内容与用户联系起来

Cookie有4个组件：

- 请求报文中一个cookie首部行
- 响应报文中一个cookie首部行
- 用户端系统一个cookie文件
- 服务器一个后端数据库

通过cookie能够在无状态的HTTP上建立一个用户会话

### session



### HTTP版本

- HTTP 1.0

规定了请求头和响应头

请求方法有GET、POST、HEAD

只支持非持续连接

- HTTP 1.1

实现持续连接，允许多个请求复用

提供管道机制，请求发送后不必等待回应可以继续请求（但是服务器依旧按顺序响应，容易造成队头堵塞）

增加了新的请求方式PUT、DELETE等

- HTTP 2.0

能够多路复用，以前文件是串行传输，容易队头堵塞，多路复用后可以多个文件一起传输

引入二进制数据帧，对数据进行顺序标识，服务器能够进行并行传输

### HTTPS

> SSL（Security Socket Layer）安全套接字层
>
> TLS（Transport Socket Layer）传输层安全协议

SSL和TLS都是为网络通信提供信息安全及数据完整性的一种安全协议，工作在传输层，对数据进行加密

HTTPS是一种通过计算机网络进行安全通信的传输协议，经由HTTP进行通信，利用SSL/TLS建立全信道，加密数据包。HTTPS使用的主要目的是提供对Web服务器的身份认证，同时保护交换数据的隐私和完整性

可以理解为在HTTP协议的下层，TCP的上层加入SSL或TLS来进行加密

默认443端口

**对比HTTP**

- HTTPS所有传输信息都进行加密传播，无法被窃听
- HTTPS具有校验机制，一旦内容被篡改，通信双方都会发现
- HTTPS配备身份证书，能够有效防止身份假冒

**HTTPS连接过程**

- 客户端请求服务器连接
- 服务器向客户端发送SSL证书
- 客户端检验证书后，生成一个用于对称加密的密钥，并用证书上的公钥进行非对称加密，在发送给服务器
- 服务器用自己的私钥进行解密，得到对称加密用的密钥
- 服务器将数据进行对称加密后发送给客户端，客户端进行对称解密就能拿到数据



## DNS 域名系统

DNS（Domain Name System）能够将主机名转换成IP地址；DNS是一个由分层的数据库实现的分布式数据库，是一个使得主机能够查询分布式数据库的应用层协议

DNS协议运行在UDP上，使用53端口

### DNS解析过程

- 用户端发送域名解析请求，在本地缓存中查找，若没有就发送请求给本地DNS服务器
- 本地DNS服务器在自己的缓存中查找，若没有就将请求发送到根域名DNS服务器
- 根目录服务器将对应的顶级域名服务器（TLD）的地址发送回来
- 本地DNS再将请求发送到TLD，TLD返回权威域名服务器的地址
- 本地DNS再将请求发送到TLD，权威域名服务器将查询结果返回
- 本地DNS 缓存查询结果，并将查询结果发送给用户端
- 用户端访问目标主机，完成解析过程



## 运输层

**网络层**提供了**主机**之间的逻辑通信，而==运输层==提供了运行在==不同主机上的进程之间==的逻辑通信

运输层在端系统中（而不是路由器中）实现的，将应用层下发的报文加上运输层首部生成运输层报文段

运输层能够提供的服务往往受制于网络层协议的服务模型，但即便是网络层协议不能提供相应的服务，运输层协议也能够提供某些服务（例如数据的可靠传输、安全等）

运输层协议有两种：

- UDP（用户数据报协议）提供了以一种无连接的、不可靠的服务
- TCP（传输控制协议）提供了一种面向连接的、可靠的服务

### 多路分解与多路复用

> 套接字：套接字是进程与网络之间传递数据的门户，==一个进程可以有一个或多个套接字==

> 套接字有唯一标识：
>
> UDP套接字由一个二元组标识，包括目的IP和目的端口号
>
> TCP套接字 由一个四元组标识，包括源IP、源端口号、目的IP和目的端口号
>
> 也就是说对于相同目的不同源的UDP报文段会定位到同一个套接字
>
> 对于相同目的不同源的TCP报文段会定位到不同套接字

- 多路复用

多路复用是指在不同的套接字收集数据块并为每个数据块封装上首部信息（用于分解）从而生成报文段，再将报文段传递到网络层

- 多路分解

多路分解是指将报文段中的数据（按照首部信息）交付到不同的套接字



#### UDP

UDP只做了运输层协议能做的最少工作，处理复用/分解还有少量的差错检测外几乎没有对IP增加别的东西

**UDP的好处**

- 无需建立连接，节省了建立连接的时延
- 无连接状态，不需要跟踪额外的参数
- 分组首部开销小，首部只有8个字节，TCP有20个
- 应用层能够更好的控制要发送的数据和发送时间

**UDP报文段结构**

<img src="https://note.youdao.com/yws/api/personal/file/49D6508FC4054251B84358AFBAF64FC5?method=download&shareKey=5e18370a328cbc8a140c898fe0c025da" alt="img" style="zoom:80%;" />

<center style = "color:#c0c0c0">UDP报文段结构</center>

虽然有简单的差错检测，但是没有差错恢复机制

#### TCP

TCP是面向连接的运输层协议，只实现在端系统中

TCP连接是一条逻辑连接，并且是点对点的，无法实现多播

TCP提供可靠的数据传输，数据能够无差错、不丢失、不重复且有序

TCP提供的是全双工的服务，两端都有发送和接收缓存

##### TCP报文段结构

![img](https://note.youdao.com/yws/api/personal/file/C9C905AE78E148C5A3BB561BC42C11D8?method=download&shareKey=192ef8c3a2e426ffb7b174197911f1df)

- 源端口号和目的端口号

- 序号：报文段数据首字节在字节流中的序号

  确认号：期望收到的下一个报文段的序号（也代表着该序号之前的数据都已经成功交付）

- 首部长度：通常选项字段为空，也就是说TCP首部长度一般是20个字节

- 接收窗口（窗口大小）：用于流量控制，指明接收方愿意接受的字节数量

##### TCP连接（三次握手）

![image-20211225211050069](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211225211050069.png)

<center style = "color:#c0c0c0">TCP三次握手</center>

- 第一次握手：客户端向服务器发送一个请求建立连接的报文段，首部信息中，SYN标志位被置为1，序列号随机生成一个数x，表示客户端的数据将从该序号开始
- 第二次握手：服务器收到客户端的请求回复一个报文段，首部信息中，SYN标志位和ACK标志位被置为1，序列号随机生成一个数y，表示服务器端的数据将从该序号开始，同时确认号为x + 1表示已收到上个报文段
- 第三次握手：客户端响应一个报文段，首部信息中，ACK标志位为1，序列号为x + 1，确认号为y + 1，表示已收到上一份报文段；同时可以在这一次的握手中向服务器请求数据（有有效载荷）

**为什么两次不行？**

**三次握手完成了客户端和用户端互相确认随机生成的初始序列号**，如果只进行两次握手，服务器对于客户端是否得知服务器数据的其实序列号无从得知

**半连接队列和SYN攻击**

在服务器接收到建立连接的请求后会进入到SYN_RCVD状态，服务器会把当前状态下的请求连接放在一个队列里，就被称作半连接队列

SYN攻击是利用TCP协议的缺陷，发送大量半连接请求，占用半连接队列（队列已满后会拒绝连接请求），耗费CPU和内存资源

缩短SYN Timeout时间或者记录IP并忽略来自某个IP的大量SYN报文可以优化这个过程

**TCP四次挥手**

<img src="https://img-blog.csdn.net/20180717204202563?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img" style="zoom:80%;" />

<center style = "color:#c0c0c0">TCP四次挥手</center>

